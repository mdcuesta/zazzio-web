'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var https = require('https');
var http = require('http');

var HttpClient = function () {
    function HttpClient(options) {
        _classCallCheck(this, HttpClient);

        this.port = 443 || options.port;
        this.https = options.https || https;
        this.http = options.http || http;
        this.headers = {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Accept': 'application/json'
        };
        this.logger = options.logger;

        if (options.userAgent) {
            this.headers['User-Agent'] = options.userAgent;
        }
    }

    _createClass(HttpClient, [{
        key: 'request',
        value: function request(endpoint, method, callback) {
            var _this = this;

            if (typeof method == 'function') {
                callback = method;
                endpoint.method = endpoint.method || 'GET';
            } else {
                endpoint.method = method;
            }

            if (endpoint.method == 'POST' || endpoint.method == 'DELETE') {
                // TODO: verify the following fix is required
                // Fix broken due ot 411 Content-Length error now sent by Nexmo API
                // PL 2016-Sept-6 - commented out Content-Length 0
                // headers['Content-Length'] = 0;
            }
            var options = {
                host: endpoint.host ? endpoint.host : 'rest.nexmo.com',
                port: this.port,
                path: endpoint.path,
                method: endpoint.method,
                headers: this.headers
            };

            // Allow existing headers to be overridden
            // Allow new headers to be added
            if (endpoint.headers) {
                Object.keys(endpoint.headers).forEach(function (key) {
                    options.headers[key] = endpoint.headers[key];
                });
            }

            this.logger.info('Request:', options, '\nBody:', endpoint.body);
            var request;

            if (options.port == 443) {
                request = this.https.request(options);
            } else {
                request = http.request(options);
            }

            request.end(endpoint.body);

            var responseReturn = '';
            request.on('response', function (response) {
                response.setEncoding('utf8');
                response.on('data', function (chunk) {
                    responseReturn += chunk;
                });
                response.on('end', function () {
                    _this.logger.info('response ended:', response.statusCode);
                    if (callback) {
                        var retJson = responseReturn;
                        var err = null;
                        if (method !== 'DELETE') {
                            try {
                                retJson = JSON.parse(responseReturn);
                            } catch (parsererr) {
                                // ignore parser error for now and send raw response to client
                                _this.logger.error(parsererr);
                                _this.logger.error('could not convert API response to JSON, above error is ignored and raw API response is returned to client');
                                _this.logger.error('Raw Error message from API ');
                                _this.logger.error(responseReturn);
                                err = parsererr;
                            }
                        }

                        if (response.statusCode < 200 || response.statusCode > 299) {
                            err = retJson;
                        }

                        callback(err, retJson);
                    }
                });
                response.on('close', function (e) {
                    _this.logger.error('problem with API request detailed stacktrace below ');
                    _this.logger.error(e);
                    callback(e);
                });
            });
            request.on('error', function (e) {
                _this.logger.error('problem with API request detailed stacktrace below ');
                _this.logger.error(e);
                callback(e);
            });
        }
    }]);

    return HttpClient;
}();

exports.default = HttpClient;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,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LEtBQVosQ0FBa0IsU0FBbEI7QUFDQSxzQ0FBSyxNQUFMLENBQVksS0FBWixDQUFrQiwyR0FBbEI7QUFDTCxzQ0FBSyxNQUFMLENBQVksS0FBWixDQUFrQiw2QkFBbEI7QUFDQSxzQ0FBSyxNQUFMLENBQVksS0FBWixDQUFrQixjQUFsQjtBQUNLLHNDQUFNLFNBQU47QUFDSDtBQUNEOztBQUVELDRCQUFHLFNBQVMsVUFBVCxHQUFzQixHQUF0QixJQUE2QixTQUFTLFVBQVQsR0FBc0IsR0FBdEQsRUFBMkQ7QUFDekQsa0NBQU0sT0FBTjtBQUNEOztBQUVELGlDQUFTLEdBQVQsRUFBYyxPQUFkO0FBQ0g7QUFDSixpQkF4QkQ7QUF5QkEseUJBQVMsRUFBVCxDQUFZLE9BQVosRUFBcUIsVUFBQyxDQUFELEVBQU87QUFDeEIsMEJBQUssTUFBTCxDQUFZLEtBQVosQ0FBa0IscURBQWxCO0FBQ0EsMEJBQUssTUFBTCxDQUFZLEtBQVosQ0FBa0IsQ0FBbEI7QUFDQSw2QkFBUyxDQUFUO0FBQ0gsaUJBSkQ7QUFLSCxhQW5DRDtBQW9DQSxvQkFBUSxFQUFSLENBQVcsT0FBWCxFQUFvQixVQUFDLENBQUQsRUFBTztBQUN2QixzQkFBSyxNQUFMLENBQVksS0FBWixDQUFrQixxREFBbEI7QUFDQSxzQkFBSyxNQUFMLENBQVksS0FBWixDQUFrQixDQUFsQjtBQUNBLHlCQUFTLENBQVQ7QUFDSCxhQUpEO0FBTUQ7Ozs7OztrQkFHWSxVIiwiZmlsZSI6Ikh0dHBDbGllbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgaHR0cHMgPSByZXF1aXJlKCdodHRwcycpO1xudmFyIGh0dHAgPSByZXF1aXJlKCdodHRwJyk7XG5cbmNsYXNzIEh0dHBDbGllbnQge1xuICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7XG4gICAgdGhpcy5wb3J0ID0gNDQzIHx8IG9wdGlvbnMucG9ydDtcbiAgICB0aGlzLmh0dHBzID0gb3B0aW9ucy5odHRwcyB8fCBodHRwcztcbiAgICB0aGlzLmh0dHAgPSAgb3B0aW9ucy5odHRwIHx8IGh0dHA7XG4gICAgdGhpcy5oZWFkZXJzID0ge1xuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcsXG4gICAgICAgICdBY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbidcbiAgICB9O1xuICAgIHRoaXMubG9nZ2VyID0gb3B0aW9ucy5sb2dnZXI7XG4gICAgXG4gICAgaWYob3B0aW9ucy51c2VyQWdlbnQpIHtcbiAgICAgIHRoaXMuaGVhZGVyc1snVXNlci1BZ2VudCddID0gb3B0aW9ucy51c2VyQWdlbnQ7XG4gICAgfVxuICB9XG4gIFxuICByZXF1ZXN0KGVuZHBvaW50LCBtZXRob2QsIGNhbGxiYWNrKSB7XG4gICAgaWYgKHR5cGVvZiBtZXRob2QgPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBjYWxsYmFjayA9IG1ldGhvZDtcbiAgICAgICAgZW5kcG9pbnQubWV0aG9kID0gZW5kcG9pbnQubWV0aG9kIHx8ICdHRVQnO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIGVuZHBvaW50Lm1ldGhvZCA9IG1ldGhvZDtcbiAgICB9XG4gICAgXG4gICAgaWYgKGVuZHBvaW50Lm1ldGhvZCA9PSAnUE9TVCcgfHwgZW5kcG9pbnQubWV0aG9kID09ICdERUxFVEUnKSB7XG4gICAgICAgIC8vIFRPRE86IHZlcmlmeSB0aGUgZm9sbG93aW5nIGZpeCBpcyByZXF1aXJlZFxuICAgICAgICAvLyBGaXggYnJva2VuIGR1ZSBvdCA0MTEgQ29udGVudC1MZW5ndGggZXJyb3Igbm93IHNlbnQgYnkgTmV4bW8gQVBJXG4gICAgICAgIC8vIFBMIDIwMTYtU2VwdC02IC0gY29tbWVudGVkIG91dCBDb250ZW50LUxlbmd0aCAwXG4gICAgICAgIC8vIGhlYWRlcnNbJ0NvbnRlbnQtTGVuZ3RoJ10gPSAwO1xuICAgIH1cbiAgICB2YXIgb3B0aW9ucyA9IHtcbiAgICAgICAgaG9zdDogZW5kcG9pbnQuaG9zdD9lbmRwb2ludC5ob3N0OidyZXN0Lm5leG1vLmNvbScsXG4gICAgICAgIHBvcnQ6IHRoaXMucG9ydCxcbiAgICAgICAgcGF0aDogZW5kcG9pbnQucGF0aCxcbiAgICAgICAgbWV0aG9kOiBlbmRwb2ludC5tZXRob2QsXG4gICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVyc1xuICAgIH07XG4gICAgXG4gICAgLy8gQWxsb3cgZXhpc3RpbmcgaGVhZGVycyB0byBiZSBvdmVycmlkZGVuXG4gICAgLy8gQWxsb3cgbmV3IGhlYWRlcnMgdG8gYmUgYWRkZWRcbiAgICBpZihlbmRwb2ludC5oZWFkZXJzKSB7XG4gICAgICBPYmplY3Qua2V5cyhlbmRwb2ludC5oZWFkZXJzKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkge1xuICAgICAgICBvcHRpb25zLmhlYWRlcnNba2V5XSA9IGVuZHBvaW50LmhlYWRlcnNba2V5XTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHRoaXMubG9nZ2VyLmluZm8oJ1JlcXVlc3Q6Jywgb3B0aW9ucywgJ1xcbkJvZHk6JywgZW5kcG9pbnQuYm9keSk7XG4gICAgdmFyIHJlcXVlc3Q7XG5cbiAgICBpZiAob3B0aW9ucy5wb3J0ID09IDQ0Mykge1xuICAgICAgICByZXF1ZXN0ID0gdGhpcy5odHRwcy5yZXF1ZXN0KG9wdGlvbnMpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJlcXVlc3QgPSBodHRwLnJlcXVlc3Qob3B0aW9ucyk7XG4gICAgfVxuICAgIFxuICAgIHJlcXVlc3QuZW5kKGVuZHBvaW50LmJvZHkpO1xuICAgIFxuICAgIHZhciByZXNwb25zZVJldHVybiA9ICcnO1xuICAgIHJlcXVlc3Qub24oJ3Jlc3BvbnNlJywgKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgIHJlc3BvbnNlLnNldEVuY29kaW5nKCd1dGY4Jyk7XG4gICAgICAgIHJlc3BvbnNlLm9uKCdkYXRhJywgKGNodW5rKSA9PiB7XG4gICAgICAgICAgICByZXNwb25zZVJldHVybiArPSBjaHVuaztcbiAgICAgICAgfSk7XG4gICAgICAgIHJlc3BvbnNlLm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci5pbmZvKCdyZXNwb25zZSBlbmRlZDonLCByZXNwb25zZS5zdGF0dXNDb2RlKTtcbiAgICAgICAgICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgICAgICAgICAgIHZhciByZXRKc29uID0gcmVzcG9uc2VSZXR1cm47XG4gICAgICAgICAgICAgICAgdmFyIGVyciA9IG51bGw7XG4gICAgICAgICAgICAgICAgaWYgKG1ldGhvZCAhPT0gJ0RFTEVURScpIHtcbiAgICAgICAgICAgICAgICAgIHRyeSB7XG5cdCAgICAgICAgICAgICAgICAgICAgcmV0SnNvbiA9IEpTT04ucGFyc2UocmVzcG9uc2VSZXR1cm4pO1xuXHQgICAgICAgICAgICAgICAgfSBjYXRjaCAocGFyc2VyZXJyKSB7XG5cdCAgICAgICAgICAgICAgICAgICAgLy8gaWdub3JlIHBhcnNlciBlcnJvciBmb3Igbm93IGFuZCBzZW5kIHJhdyByZXNwb25zZSB0byBjbGllbnRcblx0ICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihwYXJzZXJlcnIpO1xuXHQgICAgICAgICAgICAgICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdjb3VsZCBub3QgY29udmVydCBBUEkgcmVzcG9uc2UgdG8gSlNPTiwgYWJvdmUgZXJyb3IgaXMgaWdub3JlZCBhbmQgcmF3IEFQSSByZXNwb25zZSBpcyByZXR1cm5lZCB0byBjbGllbnQnKTtcblx0XHRcdFx0XHRcdCAgICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcignUmF3IEVycm9yIG1lc3NhZ2UgZnJvbSBBUEkgJyk7XG5cdFx0XHRcdFx0XHQgICAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IocmVzcG9uc2VSZXR1cm4pO1xuXHQgICAgICAgICAgICAgICAgICAgIGVyciA9IHBhcnNlcmVycjtcblx0ICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYocmVzcG9uc2Uuc3RhdHVzQ29kZSA8IDIwMCB8fCByZXNwb25zZS5zdGF0dXNDb2RlID4gMjk5KSB7XG4gICAgICAgICAgICAgICAgICBlcnIgPSByZXRKc29uO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnIsIHJldEpzb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgICByZXNwb25zZS5vbignY2xvc2UnLCAoZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ3Byb2JsZW0gd2l0aCBBUEkgcmVxdWVzdCBkZXRhaWxlZCBzdGFja3RyYWNlIGJlbG93ICcpO1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoZSk7XG4gICAgICAgICAgICBjYWxsYmFjayhlKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmVxdWVzdC5vbignZXJyb3InLCAoZSkgPT4ge1xuICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcigncHJvYmxlbSB3aXRoIEFQSSByZXF1ZXN0IGRldGFpbGVkIHN0YWNrdHJhY2UgYmVsb3cgJyk7XG4gICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGUpO1xuICAgICAgICBjYWxsYmFjayhlKTtcbiAgICB9KTtcblxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEh0dHBDbGllbnQ7XG4iXX0=